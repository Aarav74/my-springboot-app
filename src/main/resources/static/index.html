<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Boot & FastAPI Microservice</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #map-container {
            height: 600px;
            width: 100%;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 p-8 flex flex-col items-center min-h-screen">
    <div class="max-w-4xl w-full bg-white p-8 rounded-2xl shadow-xl flex flex-col space-y-8">
        <h1 class="text-4xl font-bold text-center text-gray-800">Road Finder (Spring Boot + FastAPI)</h1>
        <p class="text-center text-gray-600">First, get coordinates from Spring Boot, then map them with FastAPI.</p>

        <div id="loading" class="hidden text-center text-blue-500 font-semibold">
            Fetching map from FastAPI...
        </div>

        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
            <div class="flex-1">
                <label for="coordinates" class="block text-gray-700 font-semibold mb-2">Coordinates (lat, lon pairs):</label>
                <textarea id="coordinates" rows="8" class="w-full p-4 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-blue-500 transition-colors duration-200" placeholder="Enter coordinates on separate lines, e.g.:&#10;52.5200, 13.4050&#10;52.5205, 13.4055"></textarea>
            </div>

            <div class="flex-1 flex flex-col justify-end">
                <button id="getCoordsBtn" class="bg-green-600 text-white font-bold py-4 rounded-lg shadow-lg hover:bg-green-700 transition-all duration-300 ease-in-out transform hover:scale-105 mb-4">
                    Get Coordinates from Spring Boot
                </button>
                <button id="findRoadBtn" class="bg-blue-600 text-white font-bold py-4 rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300 ease-in-out transform hover:scale-105">
                    Find Road location
                </button>
                <div id="results" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700">Results:</h3>
                    <p id="road-coords" class="text-sm text-gray-600 mt-2 whitespace-pre-wrap"></p>
                </div>
            </div>
        </div>

        <div id="map-container"></div>
    </div>
    
    <script>
        const getCoordsBtn = document.getElementById('getCoordsBtn');
        const findRoadBtn = document.getElementById('findRoadBtn');
        const coordinatesInput = document.getElementById('coordinates');
        const roadCoordsResult = document.getElementById('road-coords');
        const loadingIndicator = document.getElementById('loading');
        const mapContainer = document.getElementById('map-container');

        // FastAPI service URL
        const FASTAPI_URL = 'http://localhost:8000';

        getCoordsBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/coordinates');
                if (!response.ok) {
                    throw new Error('Failed to get coordinates from Spring Boot.');
                }
                const points = await response.json();
                const coordsText = points.map(p => `${p[0]}, ${p[1]}`).join('\n');
                coordinatesInput.value = coordsText;
                showNotification('Coordinates loaded successfully!', 'bg-green-500');
            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, 'bg-red-600');
            }
        });

        findRoadBtn.addEventListener('click', async () => {
            const coordinatesText = coordinatesInput.value.trim();
            if (!coordinatesText) {
                showNotification('Please enter coordinates.');
                return;
            }

            const points = coordinatesText.split('\n').map(line => {
                const parts = line.split(',').map(s => parseFloat(s.trim()));
                return [parts[0], parts[1]];
            }).filter(p => !isNaN(p[0]) && !isNaN(p[1]) && p.length === 2);

            if (points.length === 0) {
                showNotification('Invalid coordinate format. Please use lat,lon on each line.');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            findRoadBtn.disabled = true;

            try {
                // This fetch call now goes directly to the FastAPI backend!
                const response = await fetch(`${FASTAPI_URL}/generate-map`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ coordinates: points }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.map_html || errorData.road_coordinates || 'Unknown error.');
                }

                const data = await response.json();
                
                if (data.map_html && data.road_coordinates) {
                    mapContainer.innerHTML = data.map_html;
                    roadCoordsResult.textContent = data.road_coordinates
                        .map(coord => `[${coord[0].toFixed(6)}, ${coord[1].toFixed(6)}]`)
                        .join('\n');
                    showNotification('Map generated successfully!', 'bg-green-500');
                } else {
                    mapContainer.innerHTML = '';
                    roadCoordsResult.textContent = 'No road found or data incomplete.';
                    showNotification('No road found or data incomplete.', 'bg-yellow-500');
                }
            } catch (error) {
                console.error('Error:', error);
                roadCoordsResult.textContent = `Error: ${error.message}`;
                showNotification(error.message, 'bg-red-600');
            } finally {
                loadingIndicator.classList.add('hidden');
                findRoadBtn.disabled = false;
            }
        });

        function showNotification(message, bgColor) {
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 left-1/2 -translate-x-1/2 ${bgColor} text-white p-4 rounded-lg shadow-lg z-50 transition-all duration-500 ease-in-out transform`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('opacity-0');
                notification.classList.add('translate-y-full');
                setTimeout(() => document.body.removeChild(notification), 500);
            }, 5000);
        }
    </script>
</body>
</html>
